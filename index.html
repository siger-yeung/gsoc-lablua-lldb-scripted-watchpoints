<!DOCTYPE html>
<!--
==============================================================================
           "GitHub HTML5 Pandoc Template" v2.2 — by Tristano Ajmone
==============================================================================
Copyright © Tristano Ajmone, 2017-2020, MIT License (MIT). Project's home:

- https://github.com/tajmone/pandoc-goodies

The CSS in this template reuses source code taken from the following projects:

- GitHub Markdown CSS: Copyright © Sindre Sorhus, MIT License (MIT):
  https://github.com/sindresorhus/github-markdown-css

- Primer CSS: Copyright © 2016-2017 GitHub Inc., MIT License (MIT):
  http://primercss.io/

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The MIT License

Copyright (c) Tristano Ajmone, 2017-2020 (github.com/tajmone/pandoc-goodies)
Copyright (c) Sindre Sorhus <sindresorhus@gmail.com> (sindresorhus.com)
Copyright (c) 2017 GitHub Inc.

"GitHub Pandoc HTML5 Template" is Copyright (c) Tristano Ajmone, 2017-2020,
released under the MIT License (MIT); it contains readaptations of substantial
portions of the following third party softwares:

(1) "GitHub Markdown CSS", Copyright (c) Sindre Sorhus, MIT License (MIT).
(2) "Primer CSS", Copyright (c) 2016 GitHub Inc., MIT License (MIT).

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
==============================================================================-->
<html>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Lua scripted watchpoints in LLDB - GSoC 2021</title>
  <style type="text/css">
@charset "UTF-8";.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";font-size:16px;line-height:1.5;word-wrap:break-word;box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto;padding:45px}.markdown-body a{color:#0366d6;background-color:transparent;text-decoration:none;-webkit-text-decoration-skip:objects}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body a:hover{text-decoration:underline}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body strong{font-weight:600}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em;margin:.67em 0;padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{padding-bottom:.3em;font-size:1.5em;border-bottom:1px solid #eaecef}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body img{border-style:none}.markdown-body svg:not(:root){overflow:hidden}.markdown-body hr{box-sizing:content-box;height:.25em;margin:24px 0;padding:0;overflow:hidden;background-color:#e1e4e8;border:0}.markdown-body hr::before{display:table;content:""}.markdown-body hr::after{display:table;clear:both;content:""}.markdown-body input{margin:0;overflow:visible;font:inherit;font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body li>p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dd{margin-left:0}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body code{font-family:SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace}.markdown-body pre{font:12px SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace;word-wrap:normal}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body table{display:block;width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:content-box;background-color:#fff}.markdown-body code{padding:.2em 0;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code::after,.markdown-body code::before{letter-spacing:-.2em;content:" "}.markdown-body pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:0 0;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:visible;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}.markdown-body pre code::after,.markdown-body pre code::before{content:normal}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body kbd{box-shadow:inset 0 -1px 0 #959da5;display:inline-block;padding:3px 5px;font:11px/10px SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace;color:#444d56;vertical-align:middle;background-color:#fcfcfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}.markdown-body::before{display:table;content:""}.markdown-body::after{display:table;clear:both;content:""}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.Alert,.Error,.Note,.Success,.Warning{padding:11px;margin-bottom:24px;border-style:solid;border-width:1px;border-radius:4px}.Alert p,.Error p,.Note p,.Success p,.Warning p{margin-top:0}.Alert p:last-child,.Error p:last-child,.Note p:last-child,.Success p:last-child,.Warning p:last-child{margin-bottom:0}.Alert{color:#246;background-color:#e2eef9;border-color:#bac6d3}.Warning{color:#4c4a42;background-color:#fff9ea;border-color:#dfd8c2}.Error{color:#911;background-color:#fcdede;border-color:#d2b2b2}.Success{color:#22662c;background-color:#e2f9e5;border-color:#bad3be}.Note{color:#2f363d;background-color:#f6f8fa;border-color:#d5d8da}.Alert h1,.Alert h2,.Alert h3,.Alert h4,.Alert h5,.Alert h6{color:#246;margin-bottom:0}.Warning h1,.Warning h2,.Warning h3,.Warning h4,.Warning h5,.Warning h6{color:#4c4a42;margin-bottom:0}.Error h1,.Error h2,.Error h3,.Error h4,.Error h5,.Error h6{color:#911;margin-bottom:0}.Success h1,.Success h2,.Success h3,.Success h4,.Success h5,.Success h6{color:#22662c;margin-bottom:0}.Note h1,.Note h2,.Note h3,.Note h4,.Note h5,.Note h6{color:#2f363d;margin-bottom:0}.Alert h1:first-child,.Alert h2:first-child,.Alert h3:first-child,.Alert h4:first-child,.Alert h5:first-child,.Alert h6:first-child,.Error h1:first-child,.Error h2:first-child,.Error h3:first-child,.Error h4:first-child,.Error h5:first-child,.Error h6:first-child,.Note h1:first-child,.Note h2:first-child,.Note h3:first-child,.Note h4:first-child,.Note h5:first-child,.Note h6:first-child,.Success h1:first-child,.Success h2:first-child,.Success h3:first-child,.Success h4:first-child,.Success h5:first-child,.Success h6:first-child,.Warning h1:first-child,.Warning h2:first-child,.Warning h3:first-child,.Warning h4:first-child,.Warning h5:first-child,.Warning h6:first-child{margin-top:0}h1.title,p.subtitle{text-align:center}h1.title.followed-by-subtitle{margin-bottom:0}p.subtitle{font-size:1.5em;font-weight:600;line-height:1.25;margin-top:0;margin-bottom:16px;padding-bottom:.3em}div.line-block{white-space:pre-line}
  </style>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<article class="markdown-body">
<header>
<h1 class="title">Lua scripted watchpoints in LLDB - GSoC 2021</h1>
</header>
<h1 id="overview">Overview</h1>
<p><a href="https://lldb.llvm.org/">LLDB</a>, a subproject of <a href="https://llvm.org/">LLVM</a>, is a powerful debugger that supports plenty of platforms. One of the featured parts in LLDB is the embedded scripting interpreter, which supports Python at first, enabling users to use popular scripting languages to hook some actions in LLDB (e.g. breakpoints, watchpoints) and then manipulate LLDB. Besides, LLDB library <code>liblldb</code> is also available as a Python library, and can be used in a standalone Python environment to gain all access to the power of LLDB. The connection between LLDB and scripting interpreter is Scripting Bridge API (a.k.a. SB API).</p>
<p>In this <a href="https://reviews.llvm.org/rG67de896229c0f1918f50a48973b7ce0007a181a9">commit</a>, Lua was first introduced into LLDB as an alternative language to access the embedded interpreter. Mentors of this GSoC project, <a href="https://reviews.llvm.org/p/tammela/">@Pedro Tammela</a> and <a href="https://reviews.llvm.org/p/JDevlieghere/">@Jonas Devlieghere</a> have already contributed a lot to these Lua parts in LLDB.</p>
<p>One specific feature of the embedded scripting interpreter is called <em>scripted watchpoints</em>. A watchpoint will monitor an expression (e.g. a variable in the frame, a register or essentially a piece of memory) and break the program if the value of that expression changes. Scripted watchpoints are just like normal watchpoints, but with a extra callback that will be executed in the scripting interpreter.</p>
<p>Before this project, Lua interpreter in LLDB could not support scripted watchpoints, because it is missing some watchpoints-related glue functions to connect LLDB with Lua interpreter. This project was originally aimed to:</p>
<ul>
<li>Add support for Lua scripted watchpoints</li>
<li>Improve the whole documentation for scripting in LLDB</li>
</ul>
<p>Considering the fact that <code>liblldb</code> does not completely work in Lua, together with the progress at the 1st evaluation in July, we decided to extend this project and add an additional task:</p>
<ul>
<li>Export <code>liblldb</code> as a Lua module</li>
</ul>
<h1 id="usage">Usage</h1>
<h2 id="hit-count-of-a-line-for-statistics">Hit Count of a Line for Statistics</h2>
<p>Given an easy C program that calculates <span class="math inline">\(\sum_{i=1}^{100} i\)</span>, with the following source</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1"></a><span class="co">// File: sum.c</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3"></a></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="op">{</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>    <span class="co">// `volatile` to prevent compiler optimizations</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>    <span class="dt">volatile</span> <span class="dt">int</span> sum <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-8"><a href="#cb1-8"></a></span>
<span id="cb1-9"><a href="#cb1-9"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;=</span> <span class="dv">100</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>    <span class="op">{</span></span>
<span id="cb1-11"><a href="#cb1-11"></a>        sum <span class="op">+=</span> i<span class="op">;</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>    <span class="op">}</span></span>
<span id="cb1-13"><a href="#cb1-13"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="op">}</span></span></code></pre></div>
<p>and its compiling command line</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span> <span class="at">-g</span> <span class="at">-o</span> sum sum.c</span></code></pre></div>
<p>Though the program is very easy, it is enough to show the power of LLDB module.</p>
<p>It is quite obvious that line 11 <code>sum += i;</code> will be executed 100 times. However, this fact can also be validated by a record-only breakpoint through scripting:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource lua numberLines"><code class="sourceCode lua"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">local</span> lldb <span class="op">=</span> <span class="fu">require</span><span class="op">(</span><span class="st">&#39;lldb&#39;</span><span class="op">)</span></span>
<span id="cb3-2"><a href="#cb3-2"></a></span>
<span id="cb3-3"><a href="#cb3-3"></a>lldb<span class="op">.</span><span class="cn">SBD</span>ebugger<span class="op">.</span>Initialize<span class="op">()</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="kw">local</span> debugger <span class="op">=</span> lldb<span class="op">.</span><span class="cn">SBD</span>ebugger<span class="op">.</span>Create<span class="op">()</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>debugger<span class="op">:</span>SetAsync<span class="op">(</span><span class="kw">false</span><span class="op">)</span></span>
<span id="cb3-6"><a href="#cb3-6"></a></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="kw">local</span> target <span class="op">=</span> debugger<span class="op">:</span>CreateTarget<span class="op">(</span><span class="st">&#39;sum&#39;</span><span class="op">)</span></span>
<span id="cb3-8"><a href="#cb3-8"></a></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="co">-- set a breakpoint at `sum += i`</span></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="kw">local</span> bp <span class="op">=</span> target<span class="op">:</span>BreakpointCreateByLocation<span class="op">(</span><span class="st">&#39;sum.c&#39;</span><span class="op">,</span> <span class="dv">11</span><span class="op">)</span></span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="co">-- to prevent the breakpoint from breaking our program</span></span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="co">-- but each hit of the breakpoint will be recorded</span></span>
<span id="cb3-13"><a href="#cb3-13"></a>bp<span class="op">:</span>SetAutoContinue<span class="op">(</span><span class="kw">true</span><span class="op">)</span></span>
<span id="cb3-14"><a href="#cb3-14"></a></span>
<span id="cb3-15"><a href="#cb3-15"></a><span class="kw">local</span> process <span class="op">=</span> target<span class="op">:</span>LaunchSimple<span class="op">(</span><span class="kw">nil</span><span class="op">,</span> <span class="kw">nil</span><span class="op">,</span> <span class="kw">nil</span><span class="op">)</span></span>
<span id="cb3-16"><a href="#cb3-16"></a></span>
<span id="cb3-17"><a href="#cb3-17"></a><span class="co">-- it should be 100</span></span>
<span id="cb3-18"><a href="#cb3-18"></a><span class="fu">print</span><span class="op">(</span>bp<span class="op">:</span>GetHitCount<span class="op">())</span></span></code></pre></div>
<h2 id="dump-data-structures-at-runtime-without-touching-sources">Dump Data Structures at Runtime without Touching Sources</h2>
<p>Here is a simple program using linked list.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1"></a><span class="co">// File: list.c</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3"></a></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="kw">struct</span> list_node</span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="op">{</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>    <span class="dt">int</span> value<span class="op">;</span></span>
<span id="cb4-7"><a href="#cb4-7"></a>    <span class="kw">struct</span> list_node <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="op">};</span></span>
<span id="cb4-9"><a href="#cb4-9"></a></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="op">{</span></span>
<span id="cb4-12"><a href="#cb4-12"></a>    <span class="kw">struct</span> list_node p<span class="op">,</span> q<span class="op">,</span> r<span class="op">;</span></span>
<span id="cb4-13"><a href="#cb4-13"></a>    <span class="kw">struct</span> list_node <span class="op">*</span>head <span class="op">=</span> <span class="op">&amp;</span>p<span class="op">;</span></span>
<span id="cb4-14"><a href="#cb4-14"></a>    p<span class="op">.</span>value <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb4-15"><a href="#cb4-15"></a>    p<span class="op">.</span>next <span class="op">=</span> <span class="op">&amp;</span>q<span class="op">;</span></span>
<span id="cb4-16"><a href="#cb4-16"></a>    q<span class="op">.</span>value <span class="op">=</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb4-17"><a href="#cb4-17"></a>    q<span class="op">.</span>next <span class="op">=</span> <span class="op">&amp;</span>r<span class="op">;</span></span>
<span id="cb4-18"><a href="#cb4-18"></a>    r<span class="op">.</span>value <span class="op">=</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb4-19"><a href="#cb4-19"></a>    r<span class="op">.</span>next <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb4-20"><a href="#cb4-20"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-21"><a href="#cb4-21"></a><span class="op">}</span></span></code></pre></div>
<p>It is possible to dump the data structure without adding dump code to source.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource lua numberLines"><code class="sourceCode lua"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">local</span> lldb <span class="op">=</span> <span class="fu">require</span><span class="op">(</span><span class="st">&#39;lldb&#39;</span><span class="op">)</span></span>
<span id="cb5-2"><a href="#cb5-2"></a></span>
<span id="cb5-3"><a href="#cb5-3"></a>lldb<span class="op">.</span><span class="cn">SBD</span>ebugger<span class="op">.</span>Initialize<span class="op">()</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="kw">local</span> debugger <span class="op">=</span> lldb<span class="op">.</span><span class="cn">SBD</span>ebugger<span class="op">.</span>Create<span class="op">()</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>debugger<span class="op">:</span>SetAsync<span class="op">(</span><span class="kw">false</span><span class="op">)</span></span>
<span id="cb5-6"><a href="#cb5-6"></a></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="kw">local</span> target <span class="op">=</span> debugger<span class="op">:</span>CreateTarget<span class="op">(</span><span class="st">&#39;list&#39;</span><span class="op">)</span></span>
<span id="cb5-8"><a href="#cb5-8"></a></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="co">-- set a breakpoint at `return 0`</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="kw">local</span> bp <span class="op">=</span> target<span class="op">:</span>BreakpointCreateByLocation<span class="op">(</span><span class="st">&#39;list.c&#39;</span><span class="op">,</span> <span class="dv">20</span><span class="op">)</span></span>
<span id="cb5-11"><a href="#cb5-11"></a></span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="kw">local</span> process <span class="op">=</span> target<span class="op">:</span>LaunchSimple<span class="op">(</span><span class="kw">nil</span><span class="op">,</span> <span class="kw">nil</span><span class="op">,</span> <span class="kw">nil</span><span class="op">)</span></span>
<span id="cb5-13"><a href="#cb5-13"></a></span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="co">-- the program should be stopped because it hits `return 0` bp</span></span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="co">-- find the thread that is stopped by breakpoint</span></span>
<span id="cb5-16"><a href="#cb5-16"></a><span class="kw">local</span> bp_thread</span>
<span id="cb5-17"><a href="#cb5-17"></a></span>
<span id="cb5-18"><a href="#cb5-18"></a><span class="cf">for</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> process<span class="op">:</span>GetNumThreads<span class="op">()</span> <span class="op">-</span> <span class="dv">1</span> <span class="cf">do</span></span>
<span id="cb5-19"><a href="#cb5-19"></a>    <span class="kw">local</span> t <span class="op">=</span> process<span class="op">:</span>GetThreadAtIndex<span class="op">(</span>i<span class="op">)</span></span>
<span id="cb5-20"><a href="#cb5-20"></a>    <span class="fu">print</span><span class="op">(</span>t<span class="op">)</span></span>
<span id="cb5-21"><a href="#cb5-21"></a>    <span class="cf">if</span> t<span class="op">:</span>IsValid<span class="op">()</span> <span class="kw">and</span> t<span class="op">:</span>GetStopReason<span class="op">()</span> <span class="op">==</span> lldb<span class="op">.</span>eStopReasonBreakpoint <span class="cf">then</span></span>
<span id="cb5-22"><a href="#cb5-22"></a>        bp_thread <span class="op">=</span> t</span>
<span id="cb5-23"><a href="#cb5-23"></a>        <span class="cf">break</span></span>
<span id="cb5-24"><a href="#cb5-24"></a>    <span class="cf">end</span></span>
<span id="cb5-25"><a href="#cb5-25"></a><span class="cf">end</span></span>
<span id="cb5-26"><a href="#cb5-26"></a></span>
<span id="cb5-27"><a href="#cb5-27"></a><span class="kw">local</span> frame <span class="op">=</span> bp_thread<span class="op">:</span>GetFrameAtIndex<span class="op">(</span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb5-28"><a href="#cb5-28"></a></span>
<span id="cb5-29"><a href="#cb5-29"></a><span class="kw">local</span> head <span class="op">=</span> frame<span class="op">:</span>FindVariable<span class="op">(</span><span class="st">&#39;head&#39;</span><span class="op">)</span></span>
<span id="cb5-30"><a href="#cb5-30"></a></span>
<span id="cb5-31"><a href="#cb5-31"></a><span class="kw">local</span> node <span class="op">=</span> head</span>
<span id="cb5-32"><a href="#cb5-32"></a></span>
<span id="cb5-33"><a href="#cb5-33"></a><span class="cf">while</span> node<span class="op">:</span>IsValid<span class="op">()</span> <span class="kw">and</span> node<span class="op">:</span>GetValue<span class="op">()</span> <span class="cf">do</span></span>
<span id="cb5-34"><a href="#cb5-34"></a>    <span class="kw">local</span> value <span class="op">=</span> node<span class="op">:</span>GetChildMemberWithName<span class="op">(</span><span class="st">&#39;value&#39;</span><span class="op">)</span></span>
<span id="cb5-35"><a href="#cb5-35"></a>    <span class="fu">print</span><span class="op">(</span>value<span class="op">:</span>GetValue<span class="op">())</span></span>
<span id="cb5-36"><a href="#cb5-36"></a>    node <span class="op">=</span> node<span class="op">:</span>GetChildMemberWithName<span class="op">(</span><span class="st">&#39;next&#39;</span><span class="op">)</span></span>
<span id="cb5-37"><a href="#cb5-37"></a><span class="cf">end</span></span></code></pre></div>
<p>Its output will look like:</p>
<pre><code>&gt; lua5.3 b.lua
thread #1: tid = 2384702, 0x0000000000401150 list`main at list.c:20:5, name = &#39;list&#39;, stop reason = breakpoint 1.1
10
100
1000
nil</code></pre>
<p>And the linked list was dumped at runtime by the help of LLDB module.</p>
<h2 id="find-bugs---a-more-complicated-example-with-embedded-scripting-interpreter">Find Bugs - A More Complicated Example with Embedded Scripting Interpreter</h2>
<p>The <a href="https://gsoc2021.sigeryeung.tk/lldb-docs/use/scripting-example.html">example</a> used by LLDB documentation is a good one to demonstrate how the scripting interpreter can assist debugging. It takes a buggy binary search tree program and uses embedded scripting interpreter to locate where the bugs lie.</p>
<h1 id="installation">Installation</h1>
<p>You will need to clone the <a href="https://github.com/llvm/llvm-project">LLVM</a> project to compile LLDB.</p>
<p>Create a build directory anywhere you like, running the command at build root to configure the project (replace <code>path/to/llvm-project/llvm</code> with your cloned one):</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cmake</span> <span class="at">-G</span> Ninja <span class="dt">\</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">-DLLVM_ENABLE_PROJECTS</span><span class="op">=</span><span class="st">&quot;clang;lldb&quot;</span> <span class="dt">\</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">-DLLDB_ENABLE_LUA</span><span class="op">=</span>ON <span class="dt">\</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>      path/to/llvm-project/llvm</span></code></pre></div>
<p>This will generate building files needed for <code>ninja</code>, then call:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ninja</span> lldb</span></code></pre></div>
<p>and <code>lldb</code> with Lua scripting features will be built.</p>
<p>You can also check other building options at <a href="https://lldb.llvm.org/resources/build.html">Building - The LLDB Debugger</a>.</p>
<p>To install <code>liblldb</code> as a Lua library, you will need to run</p>
<pre><code>ninja install</code></pre>
<p>at build root either with <code>root</code> user or set a fake prefix when configuring.</p>
<h1 id="final-code-list">Final Code List</h1>
<p>Some codes or drafts of this project could be found at <a href="https://github.com/siger-yeung/gsoc-lablua-lldb-scripted-watchpoints">GitHub</a>.</p>
<p>There are 4 pull requests in total.</p>
<ul>
<li><a href="https://reviews.llvm.org/D104281">[lldb][docs] Add reference docs for Lua scripting</a></li>
<li><a href="https://reviews.llvm.org/D105034">[lldb/lua] Add scripted watchpoints for Lua</a></li>
<li><a href="https://reviews.llvm.org/D108090">[lldb/lua] Supplement Lua bindings for lldb module</a></li>
<li><a href="https://reviews.llvm.org/D108515">[lldb/lua] Force Lua version to be 5.3</a></li>
</ul>
<p>The improved documentation can be previewed <a href="https://gsoc2021.sigeryeung.tk/lldb-docs/">here</a>.</p>
<h1 id="a-closer-look-at-my-works">A Closer Look at My Works</h1>
<h2 id="improved-documentation">Improved Documentation</h2>
<p>This project adds a plugin <code>sphinx_tabs</code> to LLDB documentation system to support an integrated view for both Lua and Python codes.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>extensions <span class="op">=</span> [<span class="st">&#39;sphinx.ext.todo&#39;</span>, <span class="st">&#39;sphinx.ext.mathjax&#39;</span>, <span class="st">&#39;sphinx.ext.intersphinx&#39;</span>, <span class="st">&#39;sphinx_tabs.tabs&#39;</span>]</span></code></pre></div>
<p>At the same time, many codes just for Python have been rewritten to Lua, together with some updates on descriptive texts of the documentation.</p>
<h2 id="swig-typemaps">SWIG &amp; Typemaps</h2>
<p>Since most parts in LLDB are written in C++, exposing APIs to other languages manually will be a quite complex project. <a href="http://www.swig.org/">SWIG</a> eases a lot of difficulties in exposing C/C++ APIs to Python and Lua.</p>
<p>The wrapper code for Python and Lua are generated automatically by SWIG. But there will be situations where additional mapping on types is required. Here is a basic example:</p>
<p>If we have a C/C++ function of the prototype:</p>
<pre><code>size_t read(void *buf, size_t length);</code></pre>
<p>and it will read at most <code>length</code> bytes data to <code>buf</code>, and return how many bytes are successfully read.</p>
<p>But Lua and Python have no direct “pointers” type, and “strings” in both Lua and Python are immutable, it is necessary and more natural to have a function of the form “read(length)” returning a string to work.</p>
<p>However, these will not be translated automatically by SWIG, and what SWIG will do is almost to keep all the prototype same as C/C++ ones.</p>
<p>Fortunately, SWIG provides a “typemap” mechanism to allow users to customize these typemaps, a typemap to adapt the function with Lua will look like:</p>
<pre><code>%typemap(in) (void *buf, size_t length) {
   $2 = luaL_checkinteger(L, $input);
   if ($2 &lt;= 0) {
      return luaL_error(L, &quot;Positive integer expected&quot;);
   }
   $1 = (char *) malloc($2);
}

%typemap(argout) (void *buf, size_t length) {
   lua_pop(L, 1); // Blow away the previous result
   if ($result == 0) {
      lua_pushliteral(L, &quot;&quot;);
   } else {
      lua_pushlstring(L, (const char *)$1, $result);
   }
   free($1);
}</code></pre>
<p>These typemaps are <strong>critical</strong> to the extended GSoC project – exporting <code>liblldb</code> as a Lua module.</p>
</article>
</body>
</html>
